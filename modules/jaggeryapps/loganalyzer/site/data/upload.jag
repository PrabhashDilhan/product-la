<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSO2 Log Analyzer</title>
    <link rel="icon" href="../../images/favicon.png" type="image/x-icon" />    
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/custom.css" rel="stylesheet">
    <link href="../../css/custom-theme.css" rel="stylesheet">
    <link href="../../css/font-awesome.min.css" rel="stylesheet">
    <link href="../../css/jquery.dataTables.min.css" rel="stylesheet">
    <script src="../../js/respond.min.js"></script>
    <script src="../../js/custom-file-input.js"></script>
    <link href="../../css/filedrag.css" rel="stylesheet">
<script>(function(e,t,n){var r=e.querySelectorAll("html")[0];r.className=r.className.replace(/(^|\s)no-js(\s|$)/,"$1js$2")})(document,window,0);</script>

    <% include("../../includes/tenantAware.jag"); %>

</head>

<body>

<div class="container col-lg-12 col-md-12 col-sm-12">

<!-- header -->
<header>
	<% include("../header/mainnav.jag");%>
</header>
<!-- /header -->

<!-- secondary header - app bar -->
	<% include("../header/sourceconfiguratoinnav.jag");%>
<!-- secondary header - app bar -->

<!-- content/body -->

<div class="row">
<div class="col-md-12">


        <!-- content -->
        <form id="upload-logfile-form" method="POST" enctype="multipart/form-data">
        <div class="container col-md-12 col-centered wr-content">

            <div id="notification-area"></div>
            <div class="wr-form col-md-4">
                <h1 class="title">Upload Log File</h1>
                <div class="text-center">

                    <style>
                    #holder { border: 10px dashed #ccc; width: 300px; min-height: 300px; margin: 20px auto;}
                    #holder.hover { border: 10px dashed #6c5c76; }
                    #holder img { display: block; margin: 10px auto; }
                    #holder p { margin: 10px; font-size: 14px; }
                    progress { width: 100%; }
                    progress:after { content: '%'; }
                    .fail { background: #c00; padding: 2px; color: #fff; }
                    .hidden { display: none !important;}
                    </style>
                    <article>
                        <div id="holder">
                        <div class="text-center">
                        Drag File
                        </div>
                        </div>
                        <p id="upload" class="hidden"><label>Drag & drop not supported, but you can still upload via this input field:<br/><input type="file"></label></p>
                        <p id="filereader">File API & FileReader API not supported</p>
                        <p id="formdata">XHR2's FormData is not supported</p>
                        <p id="progress">XHR2's upload progress isn't supported</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 40%">
                                <span class="sr-only">40% Complete (success)</span>
                            </div>
                        </div>
                    </article>
                    <script>
                    var holder = document.getElementById('holder'),
                        tests = {
                          filereader: typeof FileReader != 'undefined',
                          dnd: 'draggable' in document.createElement('span'),
                          formdata: !!window.FormData,
                          progress: "upload" in new XMLHttpRequest
                        },
                        support = {
                          filereader: document.getElementById('filereader'),
                          formdata: document.getElementById('formdata'),
                          progress: document.getElementById('progress')
                        },
                        acceptedTypes = {
                          'image/png': true,
                          'image/jpeg': true,
                          'image/gif': true
                        },
                        progress = document.getElementById('uploadprogress'),
                        fileupload = document.getElementById('upload');

                    "filereader formdata progress".split(' ').forEach(function (api) {
                      if (tests[api] === false) {
                        support[api].className = 'fail';
                      } else {
                        // FFS. I could have done el.hidden = true, but IE doesn't support
                        // hidden, so I tried to create a polyfill that would extend the
                        // Element.prototype, but then IE10 doesn't even give me access
                        // to the Element object. Brilliant.
                        support[api].className = 'hidden';
                      }
                    });

                    function previewfile(file) {
                      if (tests.filereader === true && acceptedTypes[file.type] === true) {
                        var reader = new FileReader();
                        reader.onload = function (event) {
                          var image = new Image();
                          image.src = event.target.result;
                          image.width = 250; // a fake resize
                          holder.appendChild(image);
                        };

                        reader.readAsDataURL(file);
                      }  else {
                        holder.innerHTML += '<p>Uploaded ' + file.name + ' ' + (file.size ? (file.size/1024|0) + 'K' : '');
                        console.log(file);
                      }
                    }

                    function readfiles(files) {
                        debugger;
                        var formData = tests.formdata ? new FormData() : null;
                        for (var i = 0; i < files.length; i++) {
                          if (tests.formdata) formData.append('file', files[i]);
                          previewfile(files[i]);
                        }

                        // now post a new XHR request
                        if (tests.formdata) {
                          var xhr = new XMLHttpRequest();
                          xhr.open('POST', '/devnull.php');
                          xhr.onload = function() {
                            progress.value = progress.innerHTML = 100;
                          };

                          if (tests.progress) {
                            xhr.upload.onprogress = function (event) {
                              if (event.lengthComputable) {
                                var complete = (event.loaded / event.total * 100 | 0);
                                progress.value = progress.innerHTML = complete;
                              }
                            }
                          }

                          xhr.send(formData);
                        }
                    }

                    if (tests.dnd) {
                      holder.ondragover = function () { this.className = 'hover'; return false; };
                      holder.ondragend = function () { this.className = ''; return false; };
                      holder.ondrop = function (e) {
                        this.className = '';
                        e.preventDefault();
                        readfiles(e.dataTransfer.files);
                      }
                    } else {
                      fileupload.className = 'hidden';
                      fileupload.querySelector('input').onchange = function () {
                        readfiles(this.files);
                      };
                    }

                    </script>
                </div>
                <br/>
                <div class="text-center">
                        <input type="file" name="file-upload" id="file-upload" class="inputfile inputfile-4"/>
                        <label for="file-upload"><figure><svg xmlns="http://www.w3.org/2000/svg" width="20" height="17" viewBox="0 0 20 17"><path d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"/></svg></figure> <span>Choose a file&hellip;</span></label>
                </div>
            </div>
            <div class="wr-form col-md-5">
                  <br/> <br/> <br/>

                    <label class="input-label">Start Position<span class="help-tip glyphicon glyphicon-question-sign" data-toggle="tooltip" data-placement="right" title="Start Position Type choose where Log analyzer starts initially reading files: at the beginning or at the end."></span></label>
                    <div class="input-control text">
                        <select class="form-control" id="src-type" name="sourceType">
                          <option value="file">Begining</option>
                          <option value="hdfs">Ending</option>
                        </select>
                    </div>

                    <label class="input-label">Delimeter<span class="help-tip glyphicon glyphicon-question-sign" data-toggle="tooltip" data-placement="right" title="set the new line delimiter."></span></label>
                    <span class="fld-required">*</span>
                    <div class="input-control text">
                        <input type="text" value="\n" placeholder="" id="dataset-delimeter" name="delimeter"/>
                    </div>

                    <label class="input-label">Tags<span class="help-tip glyphicon glyphicon-question-sign" data-toggle="tooltip" data-placement="right" title="Add any number of arbitrary tags to your event."></span></label>
                    <div class="input-control text">
                        <input type="text" value="1.0.0" placeholder="" id="dataset-tags" name="tags"/>
                    </div>

            </div>

        </div>
        </form>
        <!-- /content -->

</div>
</div>
<!-- /content/body -->

</div>



<!--footer class="footer">
    <p>&copy; 2015 WSO2 Inc. All Rights Reserved</p>
</footer-->

<div id="content-asset-types" style="display: none">
<div>
    <a class="ast-type-item" href="../project/projects.jag"><img src="../../images/icons/ico-projects.png" /><span>Projects</span></a>
    <a class="ast-type-item" href="../data/datasets.jag"><img src="../../images/icons/ico-datasets.png" /><span>Datasets</span></a>
</div>
</div>

<script src="../../js/jquery-1.11.1.min.js"></script>
<script src="../../js/bootstrap.min.js"></script>
<script src="../../js/wso2.ml.util.js"></script>
<script src="../../js/jquery.form.min.js"></script>
<script src="../../js/jquery.dataTables.js"></script>

<script type="text/javascript">

var baseUrl = getBaseUrl(window.location.href);

$( document ).ready(function() {
// Display only the correct dataSource input
displayDataSource();

$('#nav').affix({
      offset: {
        top: $('header').height()
      }
});

$("[data-toggle=popover]").popover();

$(".ctrl-asset-type-switcher").popover({
    html : true,
    content: function() {
        return $('#content-asset-types').html();
    }
});

$('#upload-logfile-form').ajaxForm({
    url: baseUrl + '/api/datasets',

    beforeSubmit: function(arr, $form, options) {
       return isValidDatasetName($('#dataset-name').val());
    },
    success : function(res){
         window.location = baseUrl + '/ml/site/data/datasets.jag';
    },
    error :  function(res){
        var errorText = JSON.parse(res.responseText)["exception"];
        handleNotification(errorText, '#notification-area', 'warning');
    }
});

$('#cancel-dataset').on('click', function(e){
    window.location.href = './datasets.jag';
});

// change data source input according to data source type input
$('#src-type').on('change', function(e){
    displayDataSource();
});

// show/hide DAS tables
$(document).on('click', '#select-table, #selected-table', function(e){
    $('#source-das-table').toggle();
});

// hide DAS tables when a table is selected
$(document).on('click', '.source-das-table-radio', function(e){
    $('#selected-table').val($('input[name=das-tables]:checked').val());
    $('#source-das-table').hide();
});
});

</script>
</body>
</html>
